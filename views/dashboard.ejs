<section class="text-center bg--secondary">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-12 col-12 mb-5">
                <div id="user-map" class="map-container border--round"></div>
            </div>
            <div class="col-md-12 col-12 text-left">
                <h1>Hi, Manish Sahani</h1>
            </div>
        </div>
        <!--end of row-->
    </div>
    <!--end of container-->
</section>

<section>
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                    <form class="row" id="find-service"  >
                            <div class="col-md-12">
                                <label>What issue are you facing?</label>
                                <textarea name="text" placeholder="Please describe about the problem you are facing." rows="4"></textarea>
                            </div>
                            <div class="col-md-12">
                                <label for="">Nearby Landmark</label>
                                <input type="text" name="name" placeholder="Nearby Landmark" />
                            </div>
                            <div class="col-md-12">
                                <div class="input-select">
                                    <select>
                                        <option selected="" value="Default">Some common issues</option>
                                        <option value="Small">Small</option>
                                        <option value="Medium">Medium</option>
                                        <option value="Larger">Large</option>
                                        <option value="Small">Small</option>
                                        <option value="Medium">Medium</option>
                                        <option value="Larger">Large</option>
                                    </select>
                                </div>
                            </div>
                        
                            <div class="col-md-4 mt-2">
                                <button type="submit" class="btn btn--primary">Call for Service</button>
                            </div>
                    </form>
            </div>
        </div>
    </div>    
</section>

<script src="/socket.io/socket.io.js"></script>

<script>
    var currLocation;
    function getCurrentPos() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(loadMap);
        } else {
            x.innerHTML = "Geolocation is not supported by this browser.";
        }
    }

    function initMap() { getCurrentPos() }
    
    // Initialize and add the map
    function loadMap(position) {
        var pos = {lat: position.coords.latitude, lng: position.coords.longitude};
        currLocation = pos
        console.log('Map Loading');
        var map = new google.maps.Map(document.getElementById('user-map'), { zoom: 19, center: currLocation });
        var marker = new google.maps.Marker({ position: currLocation, map: map });
    }

    var socket = io();

    socket.on('connect', function () {
        console.log('user_connected');
    })

    $('#find-service').on('submit', (e) => {
        e.preventDefault();
        if(!currLocation) currLocation = { lat: 28.6755389, lng: 77.1129107 };
        console.log('btn clicked')
        console.log(currLocation)
        socket.emit('find-vendors', { id: 100, place: "Delhi", position: currLocation }, (res) => {
            var map = new google.maps.Map(document.getElementById('user-map'), { zoom: 12, center: currLocation });
            var marker = new google.maps.Marker({ position: currLocation, map: map });
            console.log(res);
            res.forEach(item => {
                var marker = new google.maps.Marker({
                    position: item.coords, 
                    map: map,
                    icon: {
                        url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                    }
                })
            });
        });
    })
</script>

<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAymsA8qvSL5wi3_Kmf4ibtJ5OnDwHfjLM&callback=initMap">
    </script>